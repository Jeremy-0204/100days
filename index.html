<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>100 Days with Kaitlin</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #f0f0f0; font-family: sans-serif; }
        
        /* 화면 왼쪽 위 에러 로그창 */
        #debug-console {
            position: absolute; top: 0; left: 0; width: 300px; height: 200px;
            background: rgba(0,0,0,0.7); color: #00ff00; padding: 10px;
            font-size: 12px; overflow-y: auto; z-index: 9999;
            pointer-events: none; display: block;
        }

        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; justify-content: center; align-items: center; z-index: 10; }
        
        .chapter-container { position: absolute; bottom: 10%; text-align: center; opacity: 0; transition: opacity 0.5s; width: 100%; }
        .chapter-container.active { opacity: 1; }
        .chapter-container h2 { font-size: 3rem; margin: 0; color: #333; text-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .chapter-container p { color: #d4af37; font-weight: bold; letter-spacing: 2px; margin-top: 10px; font-size: 1.2rem; }
        
        #progress-bar { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); width: 6px; height: 0%; background: #d4af37; border-radius: 3px; }
        #progress-bg { position: absolute; right: 20px; top: 50%; transform: translateY(-50%); width: 6px; height: 200px; background: #ddd; border-radius: 3px; }
        
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

        /* 편지 스타일 */
        #letter-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 500px; background: rgba(255,255,255,0.95);
            padding: 30px; border-radius: 15px; box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            z-index: 100; text-align: center; opacity: 0; pointer-events: none; transition: opacity 1s;
        }
        #letter-modal.visible { opacity: 1; pointer-events: auto; }
    </style>
</head>
<body>

    <div id="debug-console">System Initializing...<br></div>

    <div id="ui-layer">
        <div id="chapter-text" class="chapter-container">
            <h2 id="chap-head">Loading...</h2>
            <p id="chap-sub">Please Wait</p>
        </div>
        <div id="progress-bg"></div>
        <div id="progress-bar"></div>
    </div>

    <div id="letter-modal">
        <h3>Happy 100 Days</h3>
        <p style="line-height: 1.6; color: #555;">
            Every day with you is an adventure.<br>
            From "HUZZAH" to quiet study nights,<br>
            thank you for being my person.<br><br>
            I love you.
        </p>
        <button onclick="document.getElementById('letter-modal').classList.remove('visible')" style="padding: 10px 20px; background: #d4af37; color: white; border: none; border-radius: 20px;">Close</button>
    </div>

    <div id="canvas-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        // 로그 출력 함수
        function log(msg) {
            const con = document.getElementById('debug-console');
            con.innerHTML += msg + "<br>";
            con.scrollTop = con.scrollHeight;
        }

        log("Script started.");

        // CONFIG
        const memories = [
            { id: 'birthday', title: "The Birthday", sub: "Green Cakes & Red Lights", color: 0xffebee, z: 0, 
              photos: ["10153.jpg", "10157.jpg", "10150.jpg", "10164.jpg"] },
            { id: 'stream', title: "Cheonggyecheon", sub: "Lights & Tacos", color: 0xe3f2fd, z: -50, 
              photos: ["11250.jpg", "11253.jpg", "11221.jpg", "11255.jpg", "11215.jpg", "11214.jpg"] },
            { id: 'daegu', title: "Daegu Winter", sub: "Cozy Vibes", color: 0xe8f5e9, z: -100, 
              photos: ["11525.jpg", "11528.jpg", "11519.jpg", "11547.jpg", "11538.jpg", "11544.jpg"] },
            { id: 'study', title: "Sinchon Scholars", sub: "Notebooks", color: 0xfff3e0, z: -150, 
              photos: ["11967.jpg", "11964.jpg", "11969.jpg", "11968.jpg"] },
            { id: 'pohang', title: "Pohang Recovery", sub: "Ocean Blue", color: 0xf3e5f5, z: -200, 
              photos: ["12851.jpg", "12900.jpg", "12913.jpg", "13110.jpg", "13069.jpg", "12969.jpg", "12999.jpg", "13051.jpg", "13098.jpg", "13118.jpg"] }
        ];

        // 3D SCENE SETUP
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f0f0);
        scene.fog = new THREE.FogExp2(0xf0f0f0, 0.02);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 20;

        const renderer = new THREE.WebGLRenderer({antialias:true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);
        log("3D Canvas Created.");

        const amb = new THREE.AmbientLight(0xffffff, 0.8); scene.add(amb);
        const dir = new THREE.DirectionalLight(0xffd700, 0.6); dir.position.set(10,20,10); scene.add(dir);

        // 이미지 로더 (플레이스홀더 기능 포함)
        const loader = new THREE.TextureLoader();
        const groups = [];

        memories.forEach(mem => {
            const grp = new THREE.Group();
            grp.position.z = mem.z;

            mem.photos.forEach(file => {
                // 1. 먼저 회색 박스(Placeholder)를 만듭니다.
                const w = 5; const h = 3.5;
                const mat = new THREE.MeshLambertMaterial({ color: 0xcccccc }); // 로딩중 = 회색
                const mesh = new THREE.Mesh(new THREE.PlaneGeometry(w,h), mat);
                
                mesh.position.set((Math.random()-0.5)*15, (Math.random()-0.5)*8, Math.random()*2);
                mesh.rotation.z = (Math.random()-0.5)*0.3;
                
                // 테두리
                const frame = new THREE.Mesh(new THREE.PlaneGeometry(w+0.2, h+0.2), new THREE.MeshBasicMaterial({color:0xffffff}));
                frame.position.z = -0.05; mesh.add(frame);
                
                grp.add(mesh);

                // 2. 이미지를 로딩 시도합니다.
                loader.load(file, (tex) => {
                    // 성공 시: 텍스처를 입히고 색을 흰색으로 변경
                    const aspect = tex.image.width / tex.image.height;
                    mesh.geometry.dispose(); // 기존 모양 삭제
                    mesh.geometry = new THREE.PlaneGeometry(5, 5/aspect); // 비율 맞춰 재생성
                    mesh.material.map = tex;
                    mesh.material.color.setHex(0xffffff);
                    mesh.material.needsUpdate = true;
                    // log("Loaded: " + file); // 너무 많으면 로그 가림
                }, undefined, (err) => {
                    // 실패 시: 빨간색으로 변경
                    log("FAIL: " + file);
                    mesh.material.color.setHex(0xff5555); // 에러 = 빨간색
                });
            });

            scene.add(grp);
            groups.push(grp);
        });

        // 요정 (Fairy) - 스크롤 끝에 등장
        const fairyGrp = new THREE.Group();
        const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.7, 1.2, 4, 8), new THREE.MeshLambertMaterial({color: 0x8e44ad}));
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshLambertMaterial({color: 0xffd54f})); head.position.y = 1.0;
        const wingGeo = new THREE.CircleGeometry(0.8, 32, 0, Math.PI);
        const wingMat = new THREE.MeshBasicMaterial({color:0xffffff, transparent:true, opacity:0.6, side:THREE.DoubleSide});
        const lWing = new THREE.Mesh(wingGeo, wingMat); lWing.position.set(-0.5, 0.6, -0.3); lWing.rotation.y = 0.5;
        const rWing = new THREE.Mesh(wingGeo, wingMat); rWing.position.set(0.5, 0.6, -0.3); rWing.rotation.y = -0.5;
        fairyGrp.add(body, head, lWing, rWing);
        fairyGrp.position.set(0, -5, -240); // 위치 조정
        scene.add(fairyGrp);

        // 스크롤 및 애니메이션
        let scrollY = 0;
        let targetZ = 20;
        const maxScroll = 260;

        // 자동 시작 (클릭 불필요)
        log("Auto-start sequence initiated.");

        function handleScroll(delta) {
            scrollY += delta * 0.05;
            scrollY = Math.max(0, Math.min(scrollY, maxScroll));
            targetZ = 10 - scrollY;

            if(scrollY > 230) {
                document.getElementById('letter-modal').classList.add('visible');
                gsap.to(fairyGrp.position, {y: 0, duration: 2, ease: "elastic.out(1, 0.5)"});
            }
        }

        window.addEventListener('wheel', e => handleScroll(e.deltaY));
        let ty=0;
        window.addEventListener('touchstart', e=>ty=e.touches[0].clientY);
        window.addEventListener('touchmove', e=>{
            const d = ty - e.touches[0].clientY;
            handleScroll(d * 2.5);
            ty=e.touches[0].clientY;
        });

        const clock = new THREE.Clock();
        const headTitle = document.getElementById('chap-head');
        const subTitle = document.getElementById('chap-sub');
        const txtBox = document.getElementById('chapter-text');
        const bar = document.getElementById('progress-bar');

        function animate(){
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            camera.position.z += (targetZ - camera.position.z)*0.05;

            // Fairy Fly
            fairyGrp.position.y += Math.sin(time*3)*0.005;
            fairyGrp.children[2].rotation.z = Math.sin(time*15)*0.6;
            fairyGrp.children[3].rotation.z = -Math.sin(time*15)*0.6;

            groups.forEach((g,i)=>{
                g.position.y = Math.sin(time + i)*0.5;
                const dist = Math.abs(g.position.z - camera.position.z);
                
                if(dist < 30){
                    scene.background.lerp(new THREE.Color(memories[i].color), 0.05);
                    scene.fog.color.lerp(new THREE.Color(memories[i].color), 0.05);
                    
                    if(dist < 20){
                        if(headTitle.innerText !== memories[i].title){
                            txtBox.classList.remove('active');
                            setTimeout(()=>{
                                headTitle.innerText=memories[i].title;
                                subTitle.innerText=memories[i].sub;
                                txtBox.classList.add('active');
                            }, 500);
                        } else if(!txtBox.classList.contains('active')) txtBox.classList.add('active');
                    }
                }
            });
            bar.style.height = (scrollY/maxScroll)*100 + "%";
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', ()=>{
            camera.aspect=window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
