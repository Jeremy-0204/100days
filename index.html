<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>100 Days Museum (Explorer Edition)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Lato:wght@300;400;700&display=swap');

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
            font-family: 'Lato', sans-serif;
            user-select: none; -webkit-user-select: none;
        }

        /* UI LAYER */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            pointer-events: none;
        }

        /* NAVIGATION BUTTONS (The "Island Hoppers") */
        .nav-btn {
            position: absolute; bottom: 40px; 
            background: rgba(15, 15, 20, 0.8); color: #d4af37;
            border: 1px solid #d4af37; padding: 15px 30px;
            font-family: 'Playfair Display', serif; font-size: 1.2rem;
            cursor: pointer; pointer-events: auto; border-radius: 50px;
            transition: all 0.3s ease; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-transform: uppercase; letter-spacing: 2px;
        }
        .nav-btn:hover { background: #d4af37; color: #fff; transform: translateY(-3px); }
        #prev-btn { left: 40px; display: none; } /* Hidden at start */
        #next-btn { right: 40px; }

        /* HEADER INFO */
        #header-info {
            position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            text-align: center; width: 80%; pointer-events: none;
            transition: opacity 0.5s;
        }
        #header-info h1 {
            font-family: 'Playfair Display', serif; font-size: 3rem; margin: 0;
            color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        #header-info p {
            font-size: 1rem; color: #d4af37; letter-spacing: 3px; text-transform: uppercase; margin-top: 10px; font-weight: bold;
        }

        /* START SCREEN */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            background: #fff; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: opacity 1.5s;
            cursor: pointer; pointer-events: auto;
        }
        #huzzah-img {
            width: 280px; border-radius: 20px; box-shadow: 0 30px 60px rgba(0,0,0,0.3);
            transition: transform 0.5s;
        }
        #huzzah-img:hover { transform: scale(1.05) rotate(2deg); }
        .click-hint {
            margin-top: 30px; font-family: 'Playfair Display', serif; font-style: italic;
            color: #d4af37; font-size: 1.5rem; animation: pulse 2s infinite; font-weight: bold;
        }
        #status-text { font-size: 0.9rem; color: #888; margin-top: 10px; font-weight: 300; }

        /* LETTER MODAL */
        #letter-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 550px; 
            background: #fffdf5; padding: 50px; border-radius: 5px; box-shadow: 0 30px 80px rgba(0,0,0,0.8);
            border: 4px double #d4af37; z-index: 200; text-align: center; opacity: 0; pointer-events: none;
            transition: opacity 1.5s; display: none;
        }
        #letter-modal.visible { opacity: 1; pointer-events: auto; display: block; }
        .letter-content h3 { font-family: 'Playfair Display', serif; font-size: 2.5rem; color: #333; margin-bottom: 30px; }
        .letter-content p { font-size: 1.2rem; line-height: 2; color: #444; margin-bottom: 40px; }
        .close-btn {
            background: transparent; color: #d4af37; border: 1px solid #d4af37; padding: 12px 40px;
            border-radius: 50px; cursor: pointer; font-size: 0.9rem; font-weight: bold; transition: all 0.3s;
        }
        .close-btn:hover { background: #d4af37; color: white; }

        /* ZOOM OVERLAY */
        #zoom-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 150; display: none;
            justify-content: center; align-items: center; cursor: zoom-out;
            pointer-events: auto; flex-direction: column; opacity: 0; transition: opacity 0.3s;
        }
        #zoom-overlay.active { opacity: 1; }
        #zoom-img { 
            max-width: 85%; max-height: 80%; border: 15px solid #fff; 
            box-shadow: 0 0 80px rgba(0,0,0,0.8); cursor: default; 
        }
        #close-hint { color: #888; margin-top: 25px; font-size: 0.8rem; letter-spacing: 3px; }

        /* TUTORIAL OVERLAY */
        #tutorial {
            position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%);
            color: rgba(255,255,255,0.6); font-size: 0.9rem; letter-spacing: 1px;
            pointer-events: none; opacity: 0; transition: opacity 1s;
        }

        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #debug-console { display: none; }
    </style>
</head>
<body>

    <div id="debug-console"></div>

    <div id="start-screen" onclick="tryStart()">
        <img id="huzzah-img" src="huzzah.gif" alt="HUZZAH" 
             onerror="this.src='https://media.giphy.com/media/MdGZp0GkF2L7i/giphy.gif'">
        <div class="click-hint" id="start-btn-text">LOADING...</div>
        <div id="status-text">Choonsik is arranging the exhibits...</div>
    </div>

    <div id="ui-layer">
        <div id="header-info">
            <h1 id="chap-head">The Birthday</h1>
            <p id="chap-sub">Green Cakes & Red Lights</p>
        </div>
        <div id="tutorial">DRAG TO EXPLORE â€¢ SCROLL TO ZOOM</div>
        <button id="prev-btn" class="nav-btn" onclick="prevMemory()">Previous</button>
        <button id="next-btn" class="nav-btn" onclick="nextMemory()">Next Memory</button>
    </div>

    <div id="letter-modal">
        <div class="letter-content">
            <h3>Happy 100 Days, Kaitlin</h3>
            <p>
                From that first "HUZZAH" to our quiet moments studying in Sinchon, every day has been an adventure.
                <br><br>
                Even when things were scary in the ER, or cold in Daegu, being with you made it warm.
                You are my favorite person to eat tacos with, to study with, and to build a future with.
                <br><br>
                Here is to 100 days, and thousands more.
                <br>
                I love you.
            </p>
            <button class="close-btn" onclick="document.getElementById('letter-modal').classList.remove('visible')">Close Letter</button>
        </div>
    </div>

    <div id="zoom-overlay" onclick="closeZoom()">
        <img id="zoom-img" src="" onclick="event.stopPropagation()">
        <div id="close-hint">TAP OUTSIDE TO CLOSE</div>
    </div>

    <div id="canvas-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // --- STARTUP ---
        let isStarted = false;
        let isReady = false;
        let loadedCount = 0;

        window.onload = function() {
            isReady = true;
            document.getElementById('start-btn-text').innerText = "ENTER MUSEUM";
            document.getElementById('start-btn-text').style.color = "#d4af37";
            document.getElementById('status-text').innerText = "Ready!";
        };

        function tryStart() {
            if (!isReady) return;
            isStarted = true;
            const screen = document.getElementById('start-screen');
            screen.style.opacity = 0;
            setTimeout(() => { screen.style.display = 'none'; }, 1500);
            
            // Show tutorial
            setTimeout(() => { document.getElementById('tutorial').style.opacity = 1; }, 2000);
            setTimeout(() => { document.getElementById('tutorial').style.opacity = 0; }, 8000);
        }

        function closeZoom() {
            const z = document.getElementById('zoom-overlay');
            z.classList.remove('active');
            setTimeout(() => { z.style.display = 'none'; }, 300);
        }

        // --- CONFIG: MEMORY ISLANDS ---
        // Coordinates for each island in the vast 3D space
        const memories = [
            { 
                id: 'birthday', 
                title: "The Birthday", 
                sub: "Green Cakes & Red Lights", 
                color: 0xff4081, 
                pos: { x: 0, y: 0, z: 0 }, 
                photos: ["10153", "10157", "10150", "10164"] 
            },
            { 
                id: 'stream', 
                title: "Cheonggyecheon", 
                sub: "Lights & Tacos", 
                color: 0x00e5ff, 
                pos: { x: -100, y: 20, z: -100 }, 
                photos: ["11250", "11253", "11221", "11255", "11215", "11214"] 
            },
            { 
                id: 'daegu', 
                title: "Daegu Christmas", 
                sub: "Cozy Winter Vibes", 
                color: 0x00e676, 
                pos: { x: 100, y: -20, z: -200 }, 
                photos: ["11525", "11528", "11519", "11547", "11538", "11544"] 
            },
            { 
                id: 'study', 
                title: "Sinchon Scholars", 
                sub: "Notebooks & Sweet Potatoes", 
                color: 0xffd740, 
                pos: { x: 0, y: 40, z: -300 }, 
                photos: ["11967", "11964", "11969", "11968"] 
            },
            { 
                id: 'pohang', 
                title: "Pohang Recovery", 
                sub: "From ER to Ocean Blue", 
                color: 0x7c4dff, 
                pos: { x: 0, y: 0, z: -450 }, 
                photos: ["12851", "12900", "12913", "13110", "13069", "12969", "12999", "13051", "13098", "13118"] 
            }
        ];

        const totalPhotos = memories.reduce((acc, val) => acc + val.photos.length, 0);
        let currentMemoryIndex = 0;

        // --- 3D SCENE ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x111116, 0.005); 

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 3000);
        camera.position.set(0, 5, 40); // Initial look position

        const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // CONTROLS
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 10;
        controls.maxDistance = 100;
        controls.enablePan = true;

        // LIGHTING
        const amb = new THREE.AmbientLight(0xffffff, 0.4); scene.add(amb);
        const spot = new THREE.SpotLight(0xffd700, 1.2);
        spot.position.set(50, 100, 50);
        spot.castShadow = true;
        scene.add(spot);

        // STARFIELD
        function createStars() {
            const geo = new THREE.BufferGeometry();
            const count = 3000;
            const pos = new Float32Array(count * 3);
            for(let i=0; i<count*3; i++) pos[i] = (Math.random()-0.5) * 1500;
            geo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            const mat = new THREE.PointsMaterial({size: 0.8, color: 0xffffff, transparent: true, opacity: 0.8});
            scene.add(new THREE.Points(geo, mat));
        }
        createStars();

        // CHOONSIK
        let choonsikSprite;
        function createChoonsik() {
            const loader = new THREE.TextureLoader();
            const tex = loader.load('choonsik.png', undefined, undefined, () => {
                return loader.load('https://cdn-icons-png.flaticon.com/512/4712/4712109.png');
            });
            const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true, side: THREE.DoubleSide });
            const geo = new THREE.PlaneGeometry(4, 4);
            choonsikSprite = new THREE.Mesh(geo, mat);
            choonsikSprite.position.set(5, 0, 5);
            scene.add(choonsikSprite);
        }
        createChoonsik();

        // GALLERY BUILDER
        const textureLoader = new THREE.TextureLoader();
        const photoMeshes = [];

        function tryLoadTexture(baseName, mesh) {
            const extensions = ['.jpg', '.JPG', '.jpeg', '.webp', '.png'];
            function attempt(index) {
                if(index >= extensions.length) {
                    mesh.material.color.setHex(0x333333);
                    return;
                }
                const url = baseName + extensions[index];
                textureLoader.load(url, (tex) => {
                    const aspect = tex.image.width / tex.image.height;
                    const w = 8; const h = w/aspect;
                    mesh.geometry.dispose();
                    mesh.geometry = new THREE.PlaneGeometry(w, h);
                    mesh.material.map = tex;
                    mesh.material.color.setHex(0xffffff);
                    mesh.material.needsUpdate = true;
                    
                    mesh.children[0].geometry.dispose();
                    mesh.children[0].geometry = new THREE.BoxGeometry(w+0.6, h+0.6, 0.3);
                    
                    mesh.userData.src = url;
                    loadedCount++;
                    document.getElementById('status-text').innerText = `Curating Museum: ${loadedCount}/${totalPhotos}`;
                }, undefined, () => attempt(index + 1));
            }
            attempt(0);
        }

        // Build Islands
        memories.forEach((mem, index) => {
            const group = new THREE.Group();
            group.position.set(mem.pos.x, mem.pos.y, mem.pos.z);

            // 1. Platform
            const platGeo = new THREE.CylinderGeometry(25, 23, 1, 64);
            const platMat = new THREE.MeshPhongMaterial({ color: 0x222222, shininess: 100, opacity: 0.9, transparent: true });
            const platform = new THREE.Mesh(platGeo, platMat);
            platform.position.y = -6;
            platform.receiveShadow = true;
            group.add(platform);

            // 2. Light
            const light = new THREE.PointLight(mem.color, 1.5, 80);
            light.position.set(0, 20, 0);
            group.add(light);

            // 3. Photos - WIDE ARC ARRANGEMENT
            const count = mem.photos.length;
            const radius = 16; // Much larger radius for spacing
            // Total arc width: 120 degrees (2/3 PI). Start from -60 to +60
            const totalArc = Math.PI * 0.8; 
            const startAngle = -totalArc / 2;
            const angleStep = totalArc / (count - 1 || 1); 

            mem.photos.forEach((baseName, i) => {
                // Calculate angle: center photo is at 0
                let angle = startAngle + (angleStep * i);
                if (count === 1) angle = 0;

                const x = Math.sin(angle) * radius;
                const z = Math.cos(angle) * radius - 10; // Push back slightly

                const mesh = new THREE.Mesh(new THREE.PlaneGeometry(5, 3.5), new THREE.MeshLambertMaterial({ color: 0x444444 }));
                
                mesh.position.set(x, (Math.random()-0.5)*2, z);
                mesh.lookAt(0, 0, 40); // Look at the viewer arrival point (approx)
                
                // Add Frame
                const frame = new THREE.Mesh(new THREE.BoxGeometry(5.4, 3.9, 0.2), new THREE.MeshStandardMaterial({color: 0xffd700, metalness: 0.8, roughness: 0.2}));
                frame.position.z = -0.15;
                mesh.add(frame);

                group.add(mesh);
                photoMeshes.push(mesh);
                tryLoadTexture(baseName, mesh);
            });

            scene.add(group);
        });

        // --- NAVIGATION LOGIC ---
        function updateUI(index) {
            const mem = memories[index];
            const head = document.getElementById('chap-head');
            const sub = document.getElementById('chap-sub');
            
            // Fade out, change text, fade in
            const info = document.getElementById('header-info');
            info.style.opacity = 0;
            setTimeout(() => {
                head.innerText = mem.title;
                sub.innerText = mem.sub;
                info.style.opacity = 1;
            }, 500);

            // Button visibility
            document.getElementById('prev-btn').style.display = index === 0 ? 'none' : 'block';
            
            const nextBtn = document.getElementById('next-btn');
            if(index === memories.length - 1) {
                nextBtn.innerText = "Open Letter";
                nextBtn.onclick = openLetter;
            } else {
                nextBtn.innerText = "Next Memory";
                nextBtn.onclick = nextMemory;
            }
        }

        function flyToMemory(index) {
            const mem = memories[index];
            
            // Target position: Slightly in front of the island (z + 40)
            const targetPos = { x: mem.pos.x, y: mem.pos.y + 5, z: mem.pos.z + 40 };
            const lookTarget = { x: mem.pos.x, y: mem.pos.y, z: mem.pos.z };

            // Animate Camera
            gsap.to(camera.position, {
                x: targetPos.x,
                y: targetPos.y,
                z: targetPos.z,
                duration: 2,
                ease: "power2.inOut",
                onUpdate: () => controls.update() // Keep controls sync
            });

            // Animate Controls Target (Where we orbit around)
            gsap.to(controls.target, {
                x: lookTarget.x,
                y: lookTarget.y,
                z: lookTarget.z,
                duration: 2,
                ease: "power2.inOut"
            });

            // Move Choonsik
            if(choonsikSprite) {
                gsap.to(choonsikSprite.position, {
                    x: mem.pos.x + 8,
                    y: mem.pos.y,
                    z: mem.pos.z + 5,
                    duration: 2.5,
                    ease: "power1.inOut"
                });
            }

            updateUI(index);
        }

        window.nextMemory = function() {
            if(currentMemoryIndex < memories.length - 1) {
                currentMemoryIndex++;
                flyToMemory(currentMemoryIndex);
            }
        }

        window.prevMemory = function() {
            if(currentMemoryIndex > 0) {
                currentMemoryIndex--;
                flyToMemory(currentMemoryIndex);
            }
        }

        window.openLetter = function() {
            document.getElementById('letter-modal').classList.add('visible');
        }

        // --- INTERACTION ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        window.addEventListener('click', e => {
            if(!isStarted) return;
            // Ignore UI clicks
            if(e.target.closest('button')) return;
            if(document.getElementById('letter-modal').classList.contains('visible')) return;
            
            // Calculate mouse pos for raycaster
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(photoMeshes);
            if(intersects.length > 0) {
                const src = intersects[0].object.userData.src;
                if(src) {
                    const zoom = document.getElementById('zoom-overlay');
                    document.getElementById('zoom-img').src = src;
                    zoom.style.display = 'flex';
                    setTimeout(() => zoom.classList.add('active'), 10);
                }
            }
        });

        // --- ANIMATION ---
        const clock = new THREE.Clock();

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            
            controls.update();

            // Choonsik Idle Animation
            if(choonsikSprite) {
                choonsikSprite.position.y += Math.sin(time * 3) * 0.02;
                choonsikSprite.lookAt(camera.position); // Always face user
            }

            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', ()=>{
            camera.aspect=window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
