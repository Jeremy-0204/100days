<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>100 Days with Kaitlin</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Lato:wght@300;400&display=swap');

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            background-color: #fdfbfb; font-family: 'Lato', sans-serif;
            user-select: none; -webkit-user-select: none;
        }

        /* --- UI OVERLAYS --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            pointer-events: none; display: flex; justify-content: center; align-items: center;
        }

        /* START SCREEN */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            background: #fff; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: opacity 1s;
            cursor: pointer; pointer-events: auto;
        }
        #huzzah-img {
            width: 280px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            transition: transform 0.2s;
        }
        #huzzah-img:hover { transform: scale(1.05); }
        
        .click-hint {
            margin-top: 25px; font-family: 'Playfair Display', serif; font-style: italic;
            color: #d4af37; font-size: 1.2rem; animation: pulse 2s infinite; font-weight: bold;
        }
        #status-text { font-size: 0.8rem; color: #aaa; margin-top: 10px; }

        /* CHAPTERS */
        .chapter-container {
            position: absolute; bottom: 15%; text-align: center; opacity: 0;
            transform: translateY(30px); transition: all 1s ease; width: 100%;
        }
        .chapter-container.active { opacity: 1; transform: translateY(0); }
        .chapter-container h2 {
            font-family: 'Playfair Display', serif; font-size: 3.5rem; margin: 0;
            background: -webkit-linear-gradient(45deg, #333, #666);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-shadow: 0 5px 15px rgba(0,0,0,0.1); padding: 0 20px;
        }
        .chapter-container p {
            font-size: 1rem; letter-spacing: 4px; text-transform: uppercase;
            color: #d4af37; margin-top: 10px; font-weight: bold;
        }

        /* LETTER MODAL */
        #letter-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 500px; background: rgba(255,255,255,0.98);
            padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.25);
            z-index: 200; text-align: center; opacity: 0; pointer-events: none;
            transition: opacity 1s; display: none;
        }
        #letter-modal.visible { opacity: 1; pointer-events: auto; display: block; }
        .letter-content h3 { font-family: 'Playfair Display', serif; font-size: 2rem; color: #d4af37; margin-bottom: 20px; }
        .letter-content p { font-size: 1rem; line-height: 1.6; color: #444; margin-bottom: 30px; }
        .close-btn {
            background: #d4af37; color: white; border: none; padding: 12px 30px;
            border-radius: 30px; cursor: pointer; font-size: 1rem; font-weight: bold;
        }

        /* ZOOM OVERLAY */
        #zoom-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 150; display: none;
            justify-content: center; align-items: center; cursor: zoom-out;
            pointer-events: auto;
        }
        #zoom-img { max-width: 95%; max-height: 90%; border: 4px solid white; box-shadow: 0 0 50px rgba(0,0,0,0.5); }

        #progress-container {
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            height: 150px; width: 3px; background: rgba(0,0,0,0.05);
        }
        #progress-bar { width: 100%; height: 0%; background: #d4af37; transition: height 0.1s; border-radius: 3px; }

        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        
        /* Debug Console (Optional) */
        #debug-console {
            position: absolute; top: 0; left: 0; width: 300px; height: 150px;
            background: rgba(0,0,0,0.7); color: #ff5555; padding: 10px;
            font-size: 12px; overflow-y: auto; z-index: 9999;
            pointer-events: none; display: none; 
        }
    </style>
</head>
<body>

    <div id="debug-console"></div>

    <div id="start-screen" onclick="tryStart()">
        <img id="huzzah-img" src="huzzah.gif" alt="HUZZAH" 
             onerror="this.src='https://media.giphy.com/media/MdGZp0GkF2L7i/giphy.gif'">
        <div class="click-hint" id="start-btn-text">LOADING...</div>
        <div id="status-text">Getting things ready</div>
    </div>

    <div id="ui-layer">
        <div id="chapter-text" class="chapter-container">
            <h2 id="chap-head">Title</h2>
            <p id="chap-sub">Subtitle</p>
        </div>
        <div id="progress-container"><div id="progress-bar"></div></div>
    </div>

    <div id="letter-modal">
        <div class="letter-content">
            <h3>Happy 100 Days, Kaitlin</h3>
            <p>
                From that first "HUZZAH" to our quiet moments studying in Sinchon, every day has been an adventure.
                <br><br>
                Even when things were scary in the ER, or cold in Daegu, being with you made it warm.
                You are my favorite person to eat tacos with, to study with, and to build a future with.
                <br><br>
                Here is to 100 days, and thousands more.
                <br>
                I love you.
            </p>
            <button class="close-btn" onclick="event.stopPropagation(); document.getElementById('letter-modal').classList.remove('visible')">Close</button>
        </div>
    </div>

    <div id="zoom-overlay" onclick="this.style.display='none'"><img id="zoom-img" src=""></div>
    <div id="canvas-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r146/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        // --- ERROR LOGGING ---
        function logError(msg) {
            const el = document.getElementById('debug-console');
            el.style.display = 'block';
            el.innerHTML += "⚠️ " + msg + "<br>";
            console.error(msg);
        }
        window.onerror = function(msg, source, lineno) {
            logError(`JS Error: ${msg} (Line ${lineno})`);
        };

        // --- GLOBAL VARIABLES ---
        let isStarted = false;
        let isReady = false;
        let targetZ = 20;
        let loadedCount = 0;
        
        // --- CONFIG ---
        const memories = [
            { id: 'birthday', title: "The Birthday", sub: "Green Cakes & Red Lights", color: 0xffebee, z: 0, 
              photos: ["10153", "10157", "10150", "10164"] },
            { id: 'stream', title: "Cheonggyecheon", sub: "Lights, Coughing & Tacos", color: 0xe3f2fd, z: -50, 
              photos: ["11250", "11253", "11221", "11255", "11215", "11214"] },
            { id: 'daegu', title: "Daegu Christmas", sub: "Cozy Winter Vibes", color: 0xe8f5e9, z: -100, 
              photos: ["11525", "11528", "11519", "11547", "11538", "11544"] },
            { id: 'study', title: "Sinchon Scholars", sub: "Notebooks & Sweet Potatoes", color: 0xfff3e0, z: -150, 
              photos: ["11967", "11964", "11969", "11968"] },
            { id: 'pohang', title: "Pohang Recovery", sub: "From ER to Ocean Blue", color: 0xf3e5f5, z: -200, 
              photos: ["12851", "12900", "12913", "13110", "13069", "12969", "12999", "13051", "13098", "13118"] }
        ];

        const totalPhotos = memories.reduce((acc, val) => acc + val.photos.length, 0);

        // --- STARTUP ---
        window.onload = function() {
            isReady = true;
            document.getElementById('start-btn-text').innerText = "CLICK TO START";
            document.getElementById('start-btn-text').style.color = "#d4af37";
            document.getElementById('status-text').innerText = "Ready!";
        };

        function tryStart() {
            if (!isReady) return;
            isStarted = true;
            targetZ = 10;
            const screen = document.getElementById('start-screen');
            screen.style.opacity = 0;
            setTimeout(() => { screen.style.display = 'none'; }, 1000);
        }

        // --- 3D SCENE ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xfdfbfb);
        scene.fog = new THREE.FogExp2(0xfdfbfb, 0.02);

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.z = 20;

        const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.7); scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffd700, 0.8); dirLight.position.set(10,20,10); dirLight.castShadow=true; scene.add(dirLight);

        // --- ROBUST LOADER ---
        // This function tries multiple extensions automatically
        const loader = new THREE.TextureLoader();
        const groups = [];
        const photoMeshes = [];

        function tryLoadTexture(baseName, mesh) {
            const extensions = ['.jpg', '.JPG', '.jpeg', '.webp', '.png'];
            
            function attempt(index) {
                if(index >= extensions.length) {
                    // Failed all extensions -> KEEP PINK BOX
                    mesh.material.color.setHex(0xff0000); // Turn RED on error
                    return;
                }
                
                const url = baseName + extensions[index];
                loader.load(url, 
                    (tex) => {
                        // Success!
                        const aspect = tex.image.width / tex.image.height;
                        mesh.geometry.dispose();
                        mesh.geometry = new THREE.PlaneGeometry(6, 6/aspect);
                        mesh.material.map = tex;
                        mesh.material.color.setHex(0xffffff); // White (normal)
                        mesh.material.needsUpdate = true;
                        mesh.userData.src = url;
                        loadedCount++;
                        document.getElementById('status-text').innerText = `Photos loaded: ${loadedCount}/${totalPhotos}`;
                    },
                    undefined,
                    () => {
                        // Fail -> Try next extension
                        attempt(index + 1);
                    }
                );
            }
            attempt(0);
        }

        memories.forEach(mem => {
            const grp = new THREE.Group();
            grp.position.z = mem.z;
            
            mem.photos.forEach(baseName => {
                // 1. Create a "Placeholder" Mesh first (Pastel Color Box)
                const geometry = new THREE.PlaneGeometry(5, 3.5);
                const material = new THREE.MeshLambertMaterial({ color: Math.random() * 0xffffff }); 
                const mesh = new THREE.Mesh(geometry, material);
                
                mesh.position.set((Math.random()-0.5)*18, (Math.random()-0.5)*10, Math.random()*4);
                mesh.rotation.z = (Math.random()-0.5)*0.4;
                mesh.castShadow = true; 
                mesh.receiveShadow = true;
                
                // Add White Frame
                const frame = new THREE.Mesh(new THREE.PlaneGeometry(5.2, 3.7), new THREE.MeshBasicMaterial({color:0xffffff}));
                frame.position.z = -0.05; 
                mesh.add(frame);
                
                grp.add(mesh);
                photoMeshes.push(mesh);

                // 2. Try to load the image onto it
                tryLoadTexture(baseName, mesh);
            });

            // Decor: Hearts
            for(let i=0; i<8; i++){
                const shape = new THREE.Shape();
                const x=0, y=0;
                shape.moveTo(x+0.25, y+0.25);
                shape.bezierCurveTo(x+0.25, y+0.25, x+0.20, y, x, y);
                shape.bezierCurveTo(x-0.30, y, x-0.30, y+0.35, x-0.30, y+0.35);
                shape.bezierCurveTo(x-0.30, y+0.55, x-0.10, y+0.77, x+0.25, y+0.95);
                shape.bezierCurveTo(x+0.60, y+0.77, x+0.80, y+0.55, x+0.80, y+0.35);
                shape.bezierCurveTo(x+0.80, y+0.35, x+0.80, y, x+0.50, y);
                shape.bezierCurveTo(x+0.35, y, x+0.25, y+0.25, x+0.25, y+0.25);
                const heart = new THREE.Mesh(new THREE.ShapeGeometry(shape), new THREE.MeshBasicMaterial({color: 0xff69b4, transparent:true, opacity:0.6}));
                heart.scale.set(0.5,0.5,0.5);
                heart.position.set((Math.random()-0.5)*30, (Math.random()-0.5)*20, (Math.random()-0.5)*10);
                heart.rotation.z = Math.PI;
                grp.add(heart);
            }
            scene.add(grp);
            groups.push(grp);
        });

        // --- FAIRY ---
        // Using CapsuleGeometry which requires Three.js r137+
        const fairyGrp = new THREE.Group();
        const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.8, 1.5, 4, 8), new THREE.MeshLambertMaterial({color: 0x8e44ad})); 
        const head = new THREE.Mesh(new THREE.SphereGeometry(0.6), new THREE.MeshLambertMaterial({color: 0xffd54f})); head.position.y = 1.2;
        const wingGeo = new THREE.CircleGeometry(0.8, 32, 0, Math.PI);
        const wingMat = new THREE.MeshBasicMaterial({color:0xffffff, transparent:true, opacity:0.6, side:THREE.DoubleSide});
        const lWing = new THREE.Mesh(wingGeo, wingMat); lWing.position.set(-0.6, 0.8, -0.3); lWing.rotation.y = 0.5;
        const rWing = new THREE.Mesh(wingGeo, wingMat); rWing.position.set(0.6, 0.8, -0.3); rWing.rotation.y = -0.5;
        fairyGrp.add(body, head, lWing, rWing);
        
        // Position it at the end
        fairyGrp.position.set(0, -5, -240); 
        scene.add(fairyGrp);

        // --- INTERACTION ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        function onInteract(x, y) {
            if(!isStarted) return;
            mouse.x = (x / window.innerWidth) * 2 - 1;
            mouse.y = -(y / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(photoMeshes);
            if(intersects.length > 0) {
                if(intersects[0].object.userData.src) {
                    document.getElementById('zoom-img').src = intersects[0].object.userData.src;
                    document.getElementById('zoom-overlay').style.display = 'flex';
                }
            }
        }

        window.addEventListener('click', e => onInteract(e.clientX, e.clientY));
        window.addEventListener('touchstart', e => {
            if(e.touches.length === 1) {
                // simple tap logic
            }
        });

        // --- SCROLL & ANIMATION ---
        let scrollY = 0;
        const maxScroll = 260; 
        
        function handleScroll(delta) {
            if(!isStarted) return;
            scrollY += delta * 0.05;
            scrollY = Math.max(0, Math.min(scrollY, maxScroll));
            targetZ = 10 - scrollY;

            if(scrollY > 230) {
                document.getElementById('letter-modal').classList.add('visible');
                // Simple animation without GSAP to prevent crash
                const fPos = fairyGrp.position.y;
                if(fPos < 0) fairyGrp.position.y += 0.1; 
            }
        }
        
        window.addEventListener('wheel', e => handleScroll(e.deltaY));
        let ty=0;
        window.addEventListener('touchstart', e=>ty=e.touches[0].clientY);
        window.addEventListener('touchmove', e=>{
            const d = ty - e.touches[0].clientY;
            handleScroll(d * 2.5);
            ty=e.touches[0].clientY;
        });

        const clock = new THREE.Clock();
        const headTitle = document.getElementById('chap-head');
        const subTitle = document.getElementById('chap-sub');
        const txtBox = document.getElementById('chapter-text');
        const bar = document.getElementById('progress-bar');

        function animate(){
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();
            camera.position.z += (targetZ - camera.position.z)*0.05;

            // Fairy Flap
            const wingSpeed = time * 15;
            fairyGrp.children[2].rotation.z = Math.sin(wingSpeed)*0.6;
            fairyGrp.children[3].rotation.z = -Math.sin(wingSpeed)*0.6;
            if(scrollY < 230) fairyGrp.position.y += Math.sin(time*3)*0.005; // Bob only if not rising

            if(isStarted){
                groups.forEach((g,i)=>{
                    g.position.y = Math.sin(time*0.5 + i)*0.5;
                    g.rotation.z = Math.sin(time*0.1 + i)*0.02;

                    const dist = Math.abs(g.position.z - camera.position.z);
                    if(dist < 35){
                        scene.background.lerp(new THREE.Color(memories[i].color), 0.05);
                        scene.fog.color.lerp(new THREE.Color(memories[i].color), 0.05);
                        
                        if(dist < 20){
                            if(headTitle.innerText !== memories[i].title){
                                txtBox.classList.remove('active');
                                setTimeout(()=>{
                                    headTitle.innerText=memories[i].title;
                                    subTitle.innerText=memories[i].sub;
                                    txtBox.classList.add('active');
                                }, 500);
                            } else if(!txtBox.classList.contains('active')) txtBox.classList.add('active');
                        }
                    }
                });
                bar.style.height = Math.min((scrollY/maxScroll)*100,100)+"%";
            }
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', ()=>{
            camera.aspect=window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
