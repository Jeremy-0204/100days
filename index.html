<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>100 Days: The Exhibition (Travel Fix)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=Lato:wght@300;400;700&display=swap');

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            background: #000;
            font-family: 'Lato', sans-serif;
            user-select: none; -webkit-user-select: none;
            touch-action: none;
        }

        /* UI LAYER */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
            pointer-events: none;
        }

        #header-info {
            position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            text-align: center; width: 100%; pointer-events: none;
            text-shadow: 0 4px 30px rgba(0,0,0,0.9);
            transition: opacity 0.5s;
        }
        #header-info h1 {
            font-family: 'Playfair Display', serif; font-size: 3rem; margin: 0;
            color: #fff; letter-spacing: -1px;
        }
        @media (max-width: 600px) { #header-info h1 { font-size: 2rem; } }

        #header-info p {
            font-size: 1rem; color: #d4af37; letter-spacing: 4px; text-transform: uppercase; margin-top: 5px; font-weight: 700;
        }

        /* JOYSTICK */
        #joystick-zone {
            position: absolute; bottom: 40px; left: 40px;
            width: 120px; height: 120px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            pointer-events: auto; 
            display: flex; justify-content: center; align-items: center;
            backdrop-filter: blur(5px);
        }
        #joystick-knob {
            width: 50px; height: 50px;
            background: rgba(255, 215, 0, 0.8);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            position: relative;
            transform: translate(0px, 0px);
        }

        /* NAV BUTTONS */
        .nav-btn {
            position: absolute; bottom: 50%; transform: translateY(50%);
            background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2);
            padding: 20px; border-radius: 50%; cursor: pointer; pointer-events: auto;
            backdrop-filter: blur(5px); transition: all 0.3s;
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
        }
        .nav-btn:hover { background: white; color: black; transform: scale(1.1); }
        #next-jump { right: 20px; }
        #prev-jump { left: 20px; display: none; }

        /* START SCREEN */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 100;
            background: #fff; display: flex; flex-direction: column;
            justify-content: center; align-items: center; transition: opacity 1.5s;
            cursor: pointer; pointer-events: auto;
        }
        #huzzah-img {
            width: 250px; border-radius: 20px; box-shadow: 0 40px 80px rgba(0,0,0,0.2);
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        #huzzah-img:hover { transform: scale(1.05) translateY(-10px); }
        .click-hint {
            margin-top: 40px; font-family: 'Playfair Display', serif; font-style: italic;
            color: #d4af37; font-size: 1.2rem; animation: pulse 2s infinite; font-weight: bold;
        }
        #status-text { font-size: 0.8rem; color: #999; margin-top: 15px; font-weight: 300; letter-spacing: 1px; }

        /* LETTER MODAL */
        #letter-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 85%; max-width: 500px; background: #fffbf0;
            padding: 40px; border-radius: 8px; box-shadow: 0 50px 100px rgba(0,0,0,0.9);
            border: 1px solid #d4af37; z-index: 200; text-align: center; opacity: 0; pointer-events: none;
            transition: opacity 1s; display: none;
        }
        #letter-modal.visible { opacity: 1; pointer-events: auto; display: block; }
        .letter-content h3 { font-family: 'Playfair Display', serif; font-size: 2rem; color: #333; margin-bottom: 20px; }
        .letter-content p { font-size: 1.1rem; line-height: 1.6; color: #555; margin-bottom: 40px; font-family: 'Playfair Display', serif; }
        .close-btn {
            background: transparent; color: #d4af37; border: 1px solid #d4af37; padding: 12px 40px;
            border-radius: 50px; cursor: pointer; font-size: 0.9rem; font-weight: bold; transition: all 0.3s;
            text-transform: uppercase; letter-spacing: 2px;
        }
        .close-btn:hover { background: #d4af37; color: white; }

        /* ZOOM OVERLAY */
        #zoom-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.96); z-index: 150; display: none;
            justify-content: center; align-items: center; cursor: zoom-out;
            pointer-events: auto; flex-direction: column; opacity: 0; transition: opacity 0.4s;
        }
        #zoom-overlay.active { opacity: 1; }
        #zoom-img { 
            max-width: 95%; max-height: 85%; border: 10px solid #fff; 
            box-shadow: 0 0 100px rgba(0,0,0,1); cursor: default; 
        }
        #close-hint { color: #666; margin-top: 30px; font-size: 0.8rem; letter-spacing: 4px; text-transform: uppercase; }

        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #debug-console { display: none; }
    </style>
</head>
<body>

    <div id="debug-console"></div>

    <div id="start-screen" onclick="tryStart()">
        <img id="huzzah-img" src="huzzah.gif" alt="HUZZAH" 
             onerror="this.src='https://media.giphy.com/media/MdGZp0GkF2L7i/giphy.gif'">
        <div class="click-hint" id="start-btn-text">LOADING...</div>
        <div id="status-text">Polishing the gold frames...</div>
    </div>

    <div id="ui-layer">
        <div id="header-info">
            <h1 id="chap-head">The Journey</h1>
            <p id="chap-sub">100 Days of Adventure</p>
        </div>
        
        <div id="joystick-zone">
            <div id="joystick-knob"></div>
        </div>

        <div id="prev-jump" class="nav-btn" onclick="jumpTo(-1)">‹</div>
        <div id="next-jump" class="nav-btn" onclick="jumpTo(1)">›</div>
    </div>

    <div id="letter-modal">
        <div class="letter-content">
            <h3>Happy 100 Days, Kaitlin</h3>
            <p>
                From that first very moment I met you, to our latest Pohang trip together, we've been through a lot already hehe
                <br><br>
                Even when things were scary in the ER, or cold in Daegu, being with you made it warm.
                You are my favorite person to eat tacos with, to study with, and to build a future with.
                Let's continue with our journey together with more HUZZAHs and love together!
                <br><br>
                Here is to 100 days, and thousands more.
                <br>
                I love you :)
            </p>
            <button class="close-btn" onclick="document.getElementById('letter-modal').classList.remove('visible')">Close</button>
        </div>
    </div>

    <div id="zoom-overlay" onclick="closeZoom()">
        <img id="zoom-img" src="" onclick="event.stopPropagation()">
        <div id="close-hint">Tap anywhere to close</div>
    </div>

    <div id="canvas-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        // --- STARTUP ---
        let isStarted = false;
        let isReady = false;
        let loadedCount = 0;

        window.onload = function() {
            isReady = true;
            document.getElementById('start-btn-text').innerText = "ENTER GALLERY";
            document.getElementById('start-btn-text').style.color = "#d4af37";
            document.getElementById('status-text').innerText = "Ready!";
        };

        function tryStart() {
            if (!isReady) return;
            isStarted = true;
            const screen = document.getElementById('start-screen');
            screen.style.opacity = 0;
            setTimeout(() => { screen.style.display = 'none'; }, 1500);
            
            gsap.to(camera.position, {z: 60, y: 20, x: 0, duration: 3, ease: "power2.out"});
            gsap.to(controls.target, {x: 0, y: 0, z: 0, duration: 3});
        }

        function closeZoom() {
            const z = document.getElementById('zoom-overlay');
            z.classList.remove('active');
            setTimeout(() => { z.style.display = 'none'; }, 400);
        }

        // --- CONFIG ---
        const memories = [
            { 
                id: 'birthday', title: "Kaitlin's Birthday!!", sub: "Shrek Colored Cake", 
                color: 0xff3366, pos: { x: 0, y: 0, z: 0 }, 
                photos: ["10153", "10157", "10150", "10164"] 
            },
            { 
                id: 'stream', title: "Cheonggyecheon", sub: "Pokemon Lights & Tacos", 
                color: 0x00d2ff, pos: { x: -80, y: 15, z: -100 }, 
                photos: ["11250", "11253", "11221", "11255", "11215", "11214"] 
            },
            { 
                id: 'daegu', title: "Daegu Christmas", sub: "Christmans Curry and Cold Kisses", 
                color: 0x00ff88, pos: { x: 80, y: -15, z: -200 }, 
                photos: ["11525", "11528", "11519", "11547", "11538", "11544"] 
            },
            { 
                id: 'study', title: "Sinchon Studying Couple", sub: "Sweet Potatoes Fairy Chunsik", 
                color: 0xffaa00, pos: { x: 0, y: 30, z: -300 }, 
                photos: ["11967", "11964", "11969", "11968"] 
            },
            { 
                id: 'pohang', title: "Pohang Trip", sub: "From ER to Ocean Blue", 
                color: 0x9d00ff, pos: { x: 0, y: 0, z: -420 }, 
                photos: ["12851", "12900", "12913", "13110", "13069", "12969", "12999", "13051", "13098", "13118"] 
            }
        ];
        const totalPhotos = memories.reduce((acc, val) => acc + val.photos.length, 0);

        // --- 3D SETUP ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.003); 

        const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 3000);
        camera.position.set(0, 100, 200); 

        const renderer = new THREE.WebGLRenderer({antialias:true, alpha:true, powerPreference: "high-performance"});
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2)); 
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // CONTROLS
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enablePan = false; 
        controls.minDistance = 20;  
        controls.maxDistance = 150; 
        controls.rotateSpeed = 0.4; 
        controls.maxPolarAngle = Math.PI / 1.8; 
        
        const amb = new THREE.AmbientLight(0xffffff, 0.6); scene.add(amb);
        const dir = new THREE.DirectionalLight(0xffd700, 1.2);
        dir.position.set(50, 100, 50);
        dir.castShadow = true;
        dir.shadow.mapSize.width = 2048;
        dir.shadow.mapSize.height = 2048;
        scene.add(dir);

        // --- CHOONSIK ---
        let choonsik, choonsikSprite;
        const playerSpeed = 0.5;

        function createChoonsik() {
            choonsik = new THREE.Group();
            scene.add(choonsik);
            
            const loader = new THREE.TextureLoader();
            const tex = loader.load('choonsik.png', undefined, undefined, () => {
                return loader.load('https://cdn-icons-png.flaticon.com/512/2589/2589175.png');
            });
            tex.minFilter = THREE.LinearFilter;
            tex.magFilter = THREE.LinearFilter;

            const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true, side: THREE.DoubleSide });
            const geo = new THREE.PlaneGeometry(6, 6);
            choonsikSprite = new THREE.Mesh(geo, mat);
            choonsikSprite.position.y = 3; 
            choonsik.add(choonsikSprite);
            
            const shadGeo = new THREE.CircleGeometry(2, 32);
            const shadMat = new THREE.MeshBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.3 });
            const shadow = new THREE.Mesh(shadGeo, shadMat);
            shadow.rotation.x = -Math.PI / 2;
            shadow.position.y = 0.1;
            choonsik.add(shadow);
            
            choonsik.position.set(0, 0, 0); 
        }
        createChoonsik();

        // --- ASSETS ---
        function createGiftBox(color) {
            const grp = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({ color: color, roughness: 0.3 });
            const box = new THREE.Mesh(new THREE.BoxGeometry(3,3,3), mat);
            box.castShadow = true; grp.add(box);
            const ribMat = new THREE.MeshStandardMaterial({ color: 0xffffff });
            grp.add(new THREE.Mesh(new THREE.BoxGeometry(3.1, 3.1, 0.5), ribMat));
            grp.add(new THREE.Mesh(new THREE.BoxGeometry(0.5, 3.1, 3.1), ribMat));
            return grp;
        }
        function createLantern(color) {
            const grp = new THREE.Group();
            const core = new THREE.Mesh(new THREE.DodecahedronGeometry(1.5), new THREE.MeshBasicMaterial({ color: color }));
            const frame = new THREE.Mesh(new THREE.DodecahedronGeometry(1.6), new THREE.MeshBasicMaterial({ color: 0x000000, wireframe: true }));
            grp.add(core, frame);
            grp.add(new THREE.PointLight(color, 2, 20));
            return grp;
        }
        function createSnowman() {
            const grp = new THREE.Group();
            const mat = new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.8 });
            const b1 = new THREE.Mesh(new THREE.SphereGeometry(1.5, 32, 32), mat); b1.position.y = 1.5;
            const b2 = new THREE.Mesh(new THREE.SphereGeometry(1.0, 32, 32), mat); b2.position.y = 3.5;
            const hat = new THREE.Mesh(new THREE.CylinderGeometry(0.6, 0.6, 1, 32), new THREE.MeshStandardMaterial({ color: 0x333333 })); hat.position.y = 4.8;
            grp.add(b1, b2, hat);
            return grp;
        }
        function createBook() {
            const grp = new THREE.Group();
            const cover = new THREE.Mesh(new THREE.BoxGeometry(2, 0.3, 3), new THREE.MeshStandardMaterial({ color: Math.random()*0xffffff }));
            const pages = new THREE.Mesh(new THREE.BoxGeometry(1.8, 0.25, 2.8), new THREE.MeshStandardMaterial({ color: 0xffffff }));
            grp.add(cover, pages);
            return grp;
        }

        // --- WORLD ---
        const textureLoader = new THREE.TextureLoader();
        const photoMeshes = [];

        function tryLoadTexture(baseName, mesh) {
            const extensions = ['.jpg', '.JPG', '.jpeg', '.webp', '.png'];
            function attempt(index) {
                if(index >= extensions.length) { mesh.material.color.setHex(0x222222); return; }
                const url = baseName + extensions[index];
                textureLoader.load(url, (tex) => {
                    tex.anisotropy = renderer.capabilities.getMaxAnisotropy();
                    tex.minFilter = THREE.LinearFilter;
                    tex.magFilter = THREE.LinearFilter;
                    const aspect = tex.image.width / tex.image.height;
                    const w = 8; const h = w/aspect;
                    mesh.geometry.dispose(); mesh.geometry = new THREE.PlaneGeometry(w, h);
                    mesh.material.map = tex; mesh.material.color.setHex(0xffffff); mesh.material.needsUpdate = true;
                    mesh.children[0].geometry.dispose(); mesh.children[0].geometry = new THREE.BoxGeometry(w+0.5, h+0.5, 0.2);
                    mesh.userData.src = url;
                    loadedCount++;
                    document.getElementById('status-text').innerText = `Curating Museum: ${loadedCount}/${totalPhotos}`;
                }, undefined, () => attempt(index + 1));
            }
            attempt(0);
        }

        memories.forEach((mem, index) => {
            const group = new THREE.Group();
            group.position.set(mem.pos.x, mem.pos.y, mem.pos.z);

            const platGeo = new THREE.CylinderGeometry(25, 22, 1, 64);
            const platMat = new THREE.MeshPhysicalMaterial({ color: 0x111111, roughness: 0.1, metalness: 0.5, transparent: true, opacity: 0.9, clearcoat: 1.0 });
            const platform = new THREE.Mesh(platGeo, platMat);
            platform.position.y = -6;
            platform.receiveShadow = true;
            group.add(platform);

            if (mem.id === 'birthday') for(let i=0; i<6; i++) { const box = createGiftBox(mem.color); box.position.set((Math.random()-0.5)*25, -4, (Math.random()-0.5)*25); box.rotation.y = Math.random(); group.add(box); }
            else if (mem.id === 'stream') for(let i=0; i<8; i++) { const lan = createLantern(0xffaa00); lan.position.set((Math.random()-0.5)*30, Math.random()*15, (Math.random()-0.5)*30); group.add(lan); }
            else if (mem.id === 'daegu') for(let i=0; i<4; i++) { const snow = createSnowman(); snow.position.set((Math.random()-0.5)*25, -4.5, (Math.random()-0.5)*25); group.add(snow); }
            else if (mem.id === 'study') for(let i=0; i<15; i++) { const book = createBook(); book.position.set((Math.random()-0.5)*20, -5 + (i*0.4), (Math.random()-0.5)*20); book.rotation.y = Math.random() * Math.PI; group.add(book); }

            const count = mem.photos.length;
            const radius = 16;
            const angleStep = (Math.PI * 1.2) / count;
            const startAngle = -(Math.PI * 1.2) / 2 + (angleStep/2);

            mem.photos.forEach((baseName, i) => {
                const angle = startAngle + (i * angleStep);
                const x = Math.sin(angle) * radius;
                const z = Math.cos(angle) * radius - 10;
                const mesh = new THREE.Mesh(new THREE.PlaneGeometry(5,3.5), new THREE.MeshBasicMaterial({color: 0x333333}));
                mesh.position.set(x, (Math.random()-0.5)*2, z);
                mesh.lookAt(0,0,40); 
                const frame = new THREE.Mesh(new THREE.BoxGeometry(5.2, 3.7, 0.2), new THREE.MeshStandardMaterial({color: 0xffd700, metalness: 0.9, roughness: 0.1}));
                frame.position.z = -0.15; mesh.add(frame);
                group.add(mesh);
                photoMeshes.push(mesh);
                tryLoadTexture(baseName, mesh);
            });
            scene.add(group);
        });

        // --- JOYSTICK LOGIC ---
        const joystick = { active: false, dx: 0, dy: 0, originX: 0, originY: 0 };
        const joyZone = document.getElementById('joystick-zone');
        const joyKnob = document.getElementById('joystick-knob');

        joyZone.addEventListener('touchstart', e => {
            joystick.active = true;
            joystick.originX = e.touches[0].clientX;
            joystick.originY = e.touches[0].clientY;
            controls.enabled = false;
        });

        window.addEventListener('touchmove', e => {
            if(joystick.active) {
                const touch = e.touches[0];
                let dx = touch.clientX - joystick.originX;
                let dy = touch.clientY - joystick.originY;
                const maxDist = 35;
                const dist = Math.sqrt(dx*dx + dy*dy);
                if(dist > maxDist) { dx = (dx / dist) * maxDist; dy = (dy / dist) * maxDist; }
                joyKnob.style.transform = `translate(${dx}px, ${dy}px)`;
                joystick.dx = dx / maxDist;
                joystick.dy = dy / maxDist;
            }
        });

        window.addEventListener('touchend', e => {
            if(joystick.active) {
                joystick.active = false;
                joystick.dx = 0; joystick.dy = 0;
                joyKnob.style.transform = `translate(0px, 0px)`;
                controls.enabled = true;
            }
        });

        // --- CONTROLS ---
        const keys = { w:false, a:false, s:false, d:false, ArrowUp:false, ArrowLeft:false, ArrowDown:false, ArrowRight:false, " ":false, Shift:false };
        window.addEventListener('keydown', e => { if(keys.hasOwnProperty(e.key)) keys[e.key] = true; });
        window.addEventListener('keyup', e => { if(keys.hasOwnProperty(e.key)) keys[e.key] = false; });

        let currentMemIndex = 0;
        let isJumping = false; // Prevents boundary check during flight
        
        window.jumpTo = function(dir) {
            if(isJumping) return;
            isJumping = true;

            let nextIdx = Math.max(0, Math.min(currentMemIndex + dir, memories.length-1));
            currentMemIndex = nextIdx; // Update immediately for logic
            const mem = memories[nextIdx];
            
            // 1. Move Focus (Orbit Center)
            gsap.to(controls.target, {
                x: mem.pos.x, y: mem.pos.y, z: mem.pos.z,
                duration: 2, ease: "power2.inOut"
            });

            // 2. Move Camera Position
            gsap.to(camera.position, {
                x: mem.pos.x, 
                y: mem.pos.y + 15, 
                z: mem.pos.z + 55, 
                duration: 2, ease: "power2.inOut"
            });

            // 3. Move Choonsik (FOLLOW US!)
            if(choonsik) {
                gsap.to(choonsik.position, {
                    x: mem.pos.x, y: mem.pos.y, z: mem.pos.z,
                    duration: 2, ease: "power2.inOut",
                    onComplete: () => { isJumping = false; }
                });
            }
        };

        // --- INTERACTION ---
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        window.addEventListener('click', e => {
            if(!isStarted || e.target.closest('.nav-btn') || e.target.closest('#joystick-zone')) return;
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(photoMeshes);
            if(intersects.length > 0 && intersects[0].object.userData.src) {
                document.getElementById('zoom-img').src = intersects[0].object.userData.src;
                const z = document.getElementById('zoom-overlay');
                z.style.display = 'flex';
                setTimeout(() => z.classList.add('active'), 10);
            }
        });

        // --- LOOP ---
        const clock = new THREE.Clock();
        const head = document.getElementById('chap-head');
        const sub = document.getElementById('chap-sub');

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            if(isStarted && choonsik) {
                // 1. Move Choonsik (WASD / Joystick)
                const moveVec = new THREE.Vector3(0,0,0);
                if(keys.w || keys.ArrowUp) moveVec.z -= 1;
                if(keys.s || keys.ArrowDown) moveVec.z += 1;
                if(keys.a || keys.ArrowLeft) moveVec.x -= 1;
                if(keys.d || keys.ArrowRight) moveVec.x += 1;
                if(joystick.active) { moveVec.z += joystick.dy; moveVec.x += joystick.dx; }

                if (moveVec.length() > 0) {
                    moveVec.normalize().multiplyScalar(playerSpeed);
                    
                    const forward = new THREE.Vector3();
                    camera.getWorldDirection(forward);
                    forward.y = 0; forward.normalize();
                    const right = new THREE.Vector3();
                    right.crossVectors(forward, new THREE.Vector3(0,1,0)).normalize();
                    
                    const finalMove = new THREE.Vector3();
                    finalMove.addScaledVector(forward, -moveVec.z);
                    finalMove.addScaledVector(right, moveVec.x);
                    
                    choonsik.position.add(finalMove);
                }

                // 2. BOUNDARY CHECK (Only when NOT jumping)
                if(!isJumping) {
                    const currentIslandPos = new THREE.Vector3(memories[currentMemIndex].pos.x, memories[currentMemIndex].pos.y, memories[currentMemIndex].pos.z);
                    const dist = choonsik.position.distanceTo(currentIslandPos);
                    const maxRadius = 22; 
                    
                    if(dist > maxRadius) {
                        const dirToCenter = new THREE.Vector3().subVectors(choonsik.position, currentIslandPos).normalize();
                        choonsik.position.copy(currentIslandPos.add(dirToCenter.multiplyScalar(maxRadius)));
                    }
                }

                choonsikSprite.position.y = 3 + Math.sin(time * 5) * 0.3;
                choonsikSprite.lookAt(camera.position); 

                controls.update();

                // 4. UI Updates
                const mem = memories[currentMemIndex];
                if(head.innerText !== mem.title) {
                    const info = document.getElementById('header-info');
                    info.style.opacity = 0;
                    setTimeout(() => {
                        head.innerText = mem.title;
                        sub.innerText = mem.sub;
                        info.style.opacity = 1;
                    }, 500);
                    
                    document.getElementById('prev-jump').style.display = currentMemIndex > 0 ? 'flex' : 'none';
                    document.getElementById('next-jump').style.display = currentMemIndex < memories.length-1 ? 'flex' : 'none';
                    if(currentMemIndex === memories.length-1) {
                        setTimeout(() => document.getElementById('letter-modal').classList.add('visible'), 2000);
                    }
                }
            }

            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', ()=>{
            camera.aspect=window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
